#!/bin/bash
set -e

repo_remote=${repo_remote:-https://github.com/superdesk/superdesk-client-core.git}

root=$(dirname $(dirname $(realpath -s $0)))
action=true . $root/superdesk-dev/core

repo_core=$repo/client-core

_repo_client() {
    echo $repo_core
}

_e2e_tests() {
    _es_snapshots

    webdriver-manager update
    time xvfb-run protractor protractor.conf.js --stackTrace --verbose\
        --baseUrl 'http://localhost'\
        --params.baseBackendUrl 'http://localhost/api'\
        #--specs spec/users_spec.js
}

_chrome() {
    if grep "google-chrome-stable" $repo_core/.travis.yml; then
        _chrome_stable
    else
        # it was using before protractor 4.0
        # e2e tests are not working with "google-chrome-stable"
        # https://github.com/superdesk/superdesk-client-core/pull/1067/
        apt-get install -y --no-install-recommends unzip xvfb libgconf-2-4 chromium-browser
        cd /tmp
        wget -N --no-verbose 'https://storage.googleapis.com/chromium-browser-continuous/Linux_x64/353893/chrome-linux.zip'
        unzip -qo chrome-linux.zip
        export CHROME_BIN=$(pwd)/chrome-linux/chrome && $CHROME_BIN --version
    fi
}

do_checks() {
    echo SUPERDESK_TESTING=true  >> $envfile
    supervisorctl restart all

    _es_wait
    _chrome

    [ -z "$ci" ] && [ -z "$e2e" ] && ci=1 && e2e=1

    cd $repo_core
    export PATH=./node_modules/.bin/:$PATH

    [ -n "$ci" ] && xvfb-run grunt ci:travis
    [ -n "$e2e" ] && _e2e_tests
}

do_finish() {
    _es_snapshots
    _activate
}

eval $action
