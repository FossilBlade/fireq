#!/bin/bash
set -ex

name=${name:-superdesk}
repo_remote=${repo_remote:-https://github.com/superdesk/superdesk.git}

root=$(dirname $(dirname $(realpath -s $0)))
. $root/common/index.sh

_envfile_append() {
    cat <<EOF
# Superdesk custom
DEFAULT_SOURCE_VALUE_FOR_MANUAL_ARTICLES=
REUTERS_USERNAME=${REUTERS_USERNAME-''}
REUTERS_PASSWORD=${REUTERS_PASSWORD-''}
EOF
}

_nginx_locations() {
    action=_nginx_locations $root/superdesk/content-api
}

_supervisor_append() {
    action=_supervisor_append $root/superdesk/content-api
}

do_backend() {
    _venv $env
    cd $repo/server
    time pip install -U -r requirements.txt

    action=do_backend $root/superdesk/content-api
}

do_frontend() {
    _activate # env vars
    _npm
    npm install -g grunt-cli

    cd $(_repo_client)
    time npm install
    time grunt build --server='http://localhost:5000/api' --ws='ws://localhost:5100'
    echo "\033[0m"
}

do_prepopulate() {
    _activate
    cd $repo/server

    [ -z "$sample_data" ] || sample_data='--sample-data'
    [ "$(python manage.py app:initialize_data --help | grep -c -- --sample-data)" = "0" ] && sample_data=

    python manage.py app:initialize_data $sample_data
    python manage.py users:create -u admin -p admin -e 'admin@example.com' --admin

    action=do_prepopulate $root/superdesk/content-api
}

eval $action
